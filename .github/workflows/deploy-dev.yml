name: Deploy to EC2 (develop)

on:
  push:
    branches: ["develop"]

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Deploy via SSH
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USER }}
          key: ${{ secrets.EC2_SSH_KEY }}
          script: |
            set -e
            APP_DIR="${{ secrets.EC2_APP_DIR }}"

            # First time: init repo (.env 등 기존 파일 보존)
            if [ ! -d "$APP_DIR/.git" ]; then
              mkdir -p "$APP_DIR"
              cd "$APP_DIR"
              git init
              git remote add origin https://github.com/first-button/first_button.git
              git fetch origin develop
              git checkout -b develop origin/develop
            fi

            cd "$APP_DIR"
            git fetch origin develop
            git reset --hard origin/develop

            # .env를 Day_One/으로 복사 (docker-compose가 읽을 수 있도록)
            cp .env Day_One/.env 2>/dev/null || true

            # Build and deploy with Docker Compose
            cd Day_One
            docker compose down
            docker compose up --build -d

            # Wait and verify
            sleep 10
            docker compose ps

            echo "DEPLOY OK: $(git rev-parse --short HEAD)"
